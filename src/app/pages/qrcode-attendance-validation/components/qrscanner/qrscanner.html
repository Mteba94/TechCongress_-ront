
@if (hasPermission() === null) {
  <div class="flex flex-col items-center justify-center py-12 space-y-4">
    <div class="relative">
      <lucide-icon [img]="icons.Camera" [size]="32" class="text-muted-foreground animate-pulse" />
      <div class="absolute -top-1 -right-1">
        <div class="w-3 h-3 bg-primary rounded-full animate-ping"></div>
      </div>
    </div>
    <div class="text-center">
      <p class="font-medium text-foreground mb-1">Verificando permisos...</p>
      <p class="text-sm text-muted-foreground">
        Comprobando acceso a la cámara
      </p>
    </div>
  </div>
}

<!-- Pantalla de Error de Permisos o Cámara No Disponible -->
@if (hasPermission() === false) {
  @if (permissionError(); as error) {
    @if (getPermissionInstructions(); as instructions) {
      <div class="space-y-6">
        <!-- Error Header -->
        <div class="text-center py-6">
          <lucide-icon [img]="icons.CameraOff" [size]="48" class="text-destructive mx-auto mb-4" />
          <h3 class="text-lg font-semibold text-foreground mb-2">
            @switch (error.type) {
              @case ('permission_denied') { Acceso a la cámara denegado }
              @case ('permanently_denied') { Permisos bloqueados }
              @case ('no_camera') { Cámara no encontrada }
              @case ('not_supported') { Navegador no compatible }
              @case ('camera_busy') { Cámara ocupada }
              @case ('constraints_error') { Error de configuración }
              @default { Error de cámara }
            }
          </h3>
          <p class="text-muted-foreground">
            {{ error.message }}
          </p>
        </div>

        <!-- Permission Guide -->
        @if (showPermissionGuide() && (error.type === 'permission_denied' || error.type === 'permanently_denied')) {
          <div class="bg-info/5 border border-info/20 rounded-lg p-4">
            <div class="flex items-start space-x-3">
              <lucide-icon [img]="icons.Info" [size]="20" class="text-info mt-0.5" />
              <div>
                <h4 class="font-medium text-info mb-2">
                  Cómo permitir acceso a la cámara en {{ instructions.browser }}:
                </h4>
                <ol class="text-sm text-info/80 space-y-1">
                  @for (step of instructions.steps; track $index) {
                    <li class="flex items-start space-x-2">
                      <span class="font-medium min-w-[1.5rem]">{{ $index + 1 }}.</span>
                      <span>{{ step }}</span>
                    </li>
                  }
                </ol>
              </div>
            </div>
          </div>
        }

        <!-- Retry Options -->
        <div class="space-y-3">
          @if (error.type !== 'not_supported') {
            <app-button
              variant="default"
              (click)="handleRetryCamera()"
              iconName="RotateCcw"
              [iconSize]="16"
              class="w-full"
            >
              <span>{{ retryCount() === 0 ? 'Solicitar acceso a la cámara' : 'Intentar nuevamente' }}</span>
            </app-button>
          }
          
          <app-button
            variant="outline"
            (click)="onScanError.emit({ type: 'manual_entry_requested', message: 'Entrada manual solicitada.' })"
            iconName="Keyboard"
            [iconSize]="16"
            class="w-full"
          >
            <span>Usar entrada manual</span>
          </app-button>
        </div>

        <!-- Additional Help -->
        <div class="bg-muted/50 rounded-lg p-4">
          <div class="flex items-start space-x-2">
            <lucide-icon [img]="icons.HelpCircle" [size]="16" class="text-muted-foreground mt-0.5" />
            <div>
              <h4 class="text-sm font-medium text-foreground mb-2">
                ¿Necesitas ayuda?
              </h4>
              <ul class="text-xs text-muted-foreground space-y-1">
                <li>• Asegúrate de que tu dispositivo tenga una cámara</li>
                <li>• Verifica que ninguna otra app esté usando la cámara</li>
                <li>• Intenta cerrar y abrir el navegador</li>
                <li>• Como alternativa, puedes usar la entrada manual</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    }
  }
}

<!-- Vista Principal del Escáner (hasPermission === true) -->
@if (hasPermission() === true) {
  <div class="space-y-4">
    <!-- Camera View -->
    <div class="relative bg-black rounded-lg overflow-hidden aspect-square">
      <video
        #videoRef
        class="w-full h-full object-cover"
        playsinline
        muted
      ></video>
      
      <!-- Scanning Overlay -->
      <div class="absolute inset-0 flex items-center justify-center">
        <!-- Corner guides -->
        <div class="relative w-48 h-48">
          <!-- Top-left corner -->
          <div class="absolute top-0 left-0 w-8 h-8 border-l-2 border-t-2 border-primary"></div>
          <!-- Top-right corner -->
          <div class="absolute top-0 right-0 w-8 h-8 border-r-2 border-t-2 border-primary"></div>
          <!-- Bottom-left corner -->
          <div class="absolute bottom-0 left-0 w-8 h-8 border-l-2 border-b-2 border-primary"></div>
          <!-- Bottom-right corner -->
          <div class="absolute bottom-0 right-0 w-8 h-8 border-r-2 border-b-2 border-primary"></div>
          
          <!-- Scanning line -->
          @if (scanningAnimation()) {
            <div class="absolute inset-x-4 top-4 bottom-4 overflow-hidden">
              <div class="w-full h-0.5 bg-primary animate-pulse absolute" 
                   [ngStyle]="{ animation: 'scan 2s linear infinite' }">
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Status indicator -->
      <div class="absolute top-4 left-4">
        <div class="flex items-center space-x-2 px-3 py-1 bg-background/80 backdrop-blur-sm rounded-full">
          <div class="w-2 h-2 rounded-full"
            [class]="isScanning() ? 'bg-success animate-pulse' : 'bg-muted'"
          ></div>
          <span class="text-sm font-medium text-foreground">
            {{ isScanning() ? 'Escaneando...' : 'Cámara inactiva' }}
          </span>
        </div>
      </div>

      <!-- Instructions overlay -->
      <div class="absolute bottom-4 left-4 right-4">
        <div class="bg-background/90 backdrop-blur-sm rounded-lg p-3">
          <div class="flex items-center space-x-2">
            <lucide-icon [img]="icons.Target" [size]="16" class="text-primary" />
            <p class="text-sm text-foreground">
              Centra el código QR dentro del marco
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden canvas for processing -->
    <canvas
      #canvasRef
      class="hidden"
    ></canvas>

    <!-- Controls -->
    <div class="flex items-center justify-center space-x-4">
      <app-button
        [variant]="isScanning() ? 'outline' : 'default'"
        (click)="toggleScanning()"
        [iconName]="isScanning() ? 'Pause' : 'Play'"
        [iconSize]="16"
      >
        <span>{{ isScanning() ? 'Pausar' : 'Iniciar' }}</span>
      </app-button>
      
      <app-button
        variant="outline"
        (click)="handleRetryCamera()"
        iconName="RotateCcw"
        [iconSize]="16"
      >
        <span>Reiniciar cámara</span>
      </app-button>
    </div>

    <!-- Tips -->
    <div class="bg-muted/50 rounded-lg p-4">
      <div class="flex items-start space-x-2">
        <lucide-icon [img]="icons.Lightbulb" [size]="16" class="text-primary mt-0.5" />
        <div>
          <h4 class="text-sm font-medium text-foreground mb-2">
            Consejos para escanear
          </h4>
          <ul class="text-xs text-muted-foreground space-y-1">
            <li>• Mantén el código QR centrado en el marco</li>
            <li>• Asegúrate de tener buena iluminación</li>
            <li>• Mantén la cámara estable por unos segundos</li>
            <li>• Si no funciona, prueba acercándote o alejándote</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- CSS for scanning animation -->
    <!-- Nota: En Angular, los estilos de @keyframes suelen ir en el archivo .css del componente -->
    <style>
      @keyframes scan {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(calc(192px - 2px)); } /* 192px = 48 (w-48) * 4 (clases de Tailwind base) */
      }
    </style>
  </div>
}