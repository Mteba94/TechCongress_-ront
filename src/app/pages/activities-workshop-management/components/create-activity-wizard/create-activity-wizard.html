<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
  <div class="bg-background rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
    <!-- Header -->
    <div class="p-6 border-b border-border">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-foreground">Crear Nueva Actividad</h2>
        <app-button variant="ghost" size="icon" (click)="close.emit()">
          <lucide-icon [img]="icons.x" size="20"></lucide-icon>
        </app-button>
      </div>
      <!-- Stepper -->
      <div class="flex items-center space-x-2 overflow-x-auto">
        <ng-container *ngFor="let step of steps; let i = index">
          <div class="flex items-center">
            <button
              (click)="goToStep(step.id)"
              class="flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap"
              [ngClass]="{
                'bg-primary text-primary-foreground': currentStep() === step.id,
                'bg-success/10 text-success hover:bg-success/20': currentStep() > step.id,
                'text-muted-foreground hover:text-foreground': currentStep() < step.id
              }"
            >
              <lucide-icon [img]="step.icon" size="16"></lucide-icon>
              <span>{{ step.title }}</span>
            </button>
            <lucide-icon *ngIf="i < steps.length - 1" [img]="icons.chevronRight" size="16" class="mx-1 text-muted-foreground"></lucide-icon>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- Form Content -->
    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 160px);">
      <ng-container [ngSwitch]="currentStep()">
        <!-- Step 1: Basic Information -->
        <div *ngSwitchCase="1" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <app-input
            label="Título de la Actividad"
            [value]="formData().titulo"
            (valueChange)="handleInputChange('titulo', $event)"
            [error]="errors().titulo"
            [required]="true"
        ></app-input>
            <app-select
              label="Categoría"
              [value]="formData()?.tipoActividadId"
              (valueChange)="handleInputChange('tipoActividadId', $event)"
              [options]="categoryOptions"
              [required]="true"
              [error]="errors()?.tipoActividadId"
            ></app-select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <app-select
              label="Nivel de Dificultad"
              [value]="formData()?.nivelDificultadId"
              (valueChange)="handleInputChange('nivelDificultadId', $event)"
              [options]="difficultyOptions"
            ></app-select>
            <app-input
              label="Requisitos"
              [value]="formData()?.requisitos"
              (valueChange)="handleInputChange('requisitos', $event)"
              placeholder="Ej: Conocimientos básicos de HTML y CSS"
            ></app-input>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium text-foreground">Descripción Detallada</label>
            <textarea
              [value]="formData()?.descripcionTotal"
            (valueChange)="handleInputChange('fullDescription', $event)"
              class="w-full h-32 p-3 border rounded-md resize-none bg-background text-foreground"
              [ngClass]="errors()?.descripcionTotal ? 'border-error' : 'border-input'"
              placeholder="Describe en qué consiste la actividad, qué aprenderán los asistentes, etc."
            ></textarea>
            <p *ngIf="errors()?.descripcionTotal" class="text-sm text-error">{{ errors()?.descripcionTotal }}</p>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium text-foreground">Imagen de Portada</label>
            <input type="file" (change)="handleFileInput($event)" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20"/>
            <p *ngIf="formData().imagen" class="text-sm text-muted-foreground mt-2">Archivo seleccionado: {{ formData().imagen.name }}</p>
          </div>
        </div>

        <!-- Step 2: Schedule & Location -->
        <div *ngSwitchCase="2" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <app-input
              label="Fecha"
              type="date"
              [value]="formData()?.fecha"
              (valueChange)="handleInputChange('fecha', $event)"
              [required]="true"
              [error]="errors()?.fecha"
              [disabled]="isDateDisabled()"
              [min]="minDate()"
              [max]="maxDate()"
            ></app-input>
            <app-input
              label="Hora de Inicio"
              type="time"
              [value]="formData()?.horaInicio"
              (valueChange)="handleInputChange('horaInicio', $event)"
              [required]="true"
              [error]="errors()?.horaInicio"
            ></app-input>
            <app-input
              label="Hora de Fin"
              type="time"
              [value]="formData()?.horaFin"
              (valueChange)="handleInputChange('horaFin', $event)"
            ></app-input>
          </div>
          <div class="space-y-4">
            <label class="text-sm font-medium text-foreground">Tipo de Ubicación</label>
            <div class="grid grid-cols-2 gap-4">
              <button
                *ngFor="let type of ['virtual', 'presential']"
                type="button"
                (click)="handleInputChange('locationType', type)"
                class="p-4 border rounded-lg text-center transition-colors"
                [ngClass]="formData()?.locationType === type ? 'border-primary bg-primary/10 text-primary' : 'border-border hover:border-primary/50'"
              >
                <lucide-icon
                  [img]="type === 'virtual' ? icons.monitor : icons.mapPin"
                  size="24"
                  class="mx-auto mb-2"
                ></lucide-icon>
                <span class="text-sm font-medium">
                  {{ type === 'virtual' ? 'Virtual' : 'Presencial' }}
                </span>
              </button>
            </div>
          </div>
          <app-input
            *ngIf="formData()?.locationType === 'virtual'"
            label="Plataforma Virtual"
            [value]="formData()?.platform"
            (valueChange)="handleInputChange('platform', $event)"
            placeholder="Zoom, Google Meet, Teams"
            [error]="errors()?.platform"
          ></app-input>
          <div *ngIf="formData()?.locationType === 'presential'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <app-input
              label="Sala o Ubicación Física"
              [value]="formData()?.room"
              (valueChange)="handleInputChange('room', $event)"
              placeholder="Aula Magna, Sala A"
              [error]="errors()?.room"
            ></app-input>
          </div>
        </div>

        <!-- Step 3: Instructor -->
        <div *ngSwitchCase="3" class="space-y-6 min-h-[350px]">
          <div class="animate-fade-in">
            <app-select
              label="Instructor"
              [value]="formData()?.ponenteId"
              (valueChange)="handleInputChange('ponenteId', $event)"
              [options]="instructorOptions"
              [error]="errors()?.ponenteId"
              placeholder="Seleccione un instructor"
              [required]="true"
            ></app-select>
          </div>
        </div>

        <!-- Step 4: Content & Materials -->
        <div *ngSwitchCase="4" class="space-y-6">
          <div class="space-y-4">
            <label class="text-sm font-medium text-foreground">Objetivos de la Actividad</label>
            <div *ngFor="let objective of formData().objetivosActividad; let i = index; trackBy: trackByIndex" class="flex items-center space-x-2">
              <app-input
                class="flex-grow"
                [value]="objective"
                (valueChange)="handleObjectiveChange(i, $event)"
                placeholder="Ej: Implementar autenticación con JWT"
              ></app-input>
              <button
                type="button"
                (click)="removeObjective(i)"
                [disabled]="formData().objetivosActividad.length <= 1"
                class="flex-shrink-0 p-2 text-red-500 hover:bg-red-500/10 rounded-full"
              >
                <lucide-icon [img]="icons.trash2" size="16"></lucide-icon>
              </button>
            </div>
            <button type="button" (click)="addObjective()" class="flex items-center space-x-2 text-sm font-medium text-primary hover:text-primary/80">
              <lucide-icon [img]="icons.plusCircle" size="16"></lucide-icon>
              <span>Añadir Objetivo</span>
            </button>
          </div>
          <div class="space-y-4">
            <label class="text-sm font-medium text-foreground">Materiales Requeridos</label>
            <div *ngFor="let material of formData().materialesActividad; let i = index; trackBy: trackByIndex" class="flex items-center space-x-2">
              <app-input
                class="flex-grow"
                [value]="material"
                (valueChange)="handleMaterialChange(i, $event)"
                placeholder="Ej: Laptop con Node.js instalado"
              ></app-input>
              <button
                type="button"
                (click)="removeMaterial(i)"
                [disabled]="formData().materialesActividad.length <= 1"
                class="flex-shrink-0 p-2 text-red-500 hover:bg-red-500/10 rounded-full"
              >
                <lucide-icon [img]="icons.trash2" size="16"></lucide-icon>
              </button>
            </div>
            <button type="button" (click)="addMaterial()" class="flex items-center space-x-2 text-sm font-medium text-primary hover:text-primary/80">
              <lucide-icon [img]="icons.plusCircle" size="16"></lucide-icon>
              <span>Añadir Material</span>
            </button>
          </div>
        </div>

        <!-- Step 5: Capacity -->
        <div *ngSwitchCase="5" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <app-input
              label="Cupos Totales"
              type="number"
              [value]="formData()?.cuposTotal"
              (valueChange)="handleInputChange('cuposTotal', $event)"
              placeholder="30"
              min="1"
              max="1000"
              [required]="true"
              [error]="errors()?.cuposTotal"
            ></app-input>
          </div>
        </div>

        <!-- Step 6: Final Review -->
        <div *ngSwitchCase="6" class="space-y-6">
          <div class="bg-muted/50 p-6 rounded-lg">
            <h3 class="font-semibold text-foreground mb-4">Resumen de la Actividad</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <div>
                  <p class="text-sm font-medium text-muted-foreground">Título</p>
                  <p class="text-foreground">{{ formData()?.titulo }}</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-muted-foreground">Categoría</p>
                  <p class="text-foreground">{{ getCategoryName(formData().tipoActividadId) }}</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-muted-foreground">Instructor</p>
                  <p class="text-foreground">{{ getInstructorName(formData().ponenteId) }}</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-muted-foreground">Capacidad</p>
                  <p class="text-foreground">{{ formData()?.cuposTotal }} participantes</p>
                </div>
              </div>
              <div class="space-y-3">
                <div>
                  <p class="text-sm font-medium text-muted-foreground">Fecha</p>
                  <p class="text-foreground">{{ formData().fecha }}</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-muted-foreground">Horario</p>
                  <p class="text-foreground">{{ formData()?.horaInicio }} - {{ formData()?.horaFin }}</p>
                </div>
                <div>
                  <p class="text-sm font-medium text-muted-foreground">Ubicación</p>
                  <p class="text-foreground">
                    <span *ngIf="formData()?.locationType === 'virtual'">Virtual ({{ formData()?.platform }})</span>
                    <span *ngIf="formData()?.locationType === 'presential'">{{ formData()?.room }}</span>
                  </p>
                </div>
              </div>
            </div>
            <div *ngIf="formData()?.descripcionTotal" class="mt-4">
              <p class="text-sm font-medium text-muted-foreground mb-1">Descripción</p>
              <p class="text-sm text-foreground whitespace-pre-wrap">{{ formData()?.descripcionTotal }}</p>
            </div>
          </div>
        </div>
        
        <div *ngSwitchDefault>Paso no encontrado</div>
      </ng-container>
    </div>

    <!-- Footer / Actions -->
    <div class="p-6 border-t border-border mt-auto">
      <div class="flex items-center justify-between">
        <app-button
          variant="outline"
          (click)="handlePrevious()"
          [disabled]="currentStep() === 1"
          iconName="ChevronLeft"
          iconPosition="left"
        >
          Anterior
        </app-button>

        <div class="text-sm text-muted-foreground">
          Paso {{ currentStep() }} de {{ steps.length }}
        </div>

        <app-button *ngIf="steps && currentStep() < steps.length" (click)="handleNext()" iconName="ChevronRight" iconPosition="right">
          Siguiente
        </app-button>
        <app-button *ngIf="currentStep() === steps?.length" (click)="handleSubmit()" iconName="Check" iconPosition="left">
          Crear Actividad
        </app-button>
      </div>
    </div>
  </div>
</div>
