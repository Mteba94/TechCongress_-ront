<!-- Loading Skeleton -->
@if (loading()) {
  <div class="border border-border rounded-lg">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-border">
        <thead class="bg-muted/50">
          <tr>
            <th class="px-6 py-3"><div class="h-4 bg-muted rounded animate-pulse"></div></th>
            <th class="px-6 py-3"><div class="h-4 bg-muted rounded animate-pulse"></div></th>
            <th class="px-6 py-3"><div class="h-4 bg-muted rounded animate-pulse"></div></th>
            <th class="px-6 py-3"><div class="h-4 bg-muted rounded animate-pulse"></div></th>
            <th class="px-6 py-3"><div class="h-4 bg-muted rounded animate-pulse"></div></th>
            <th class="px-6 py-3"><div class="h-4 bg-muted rounded animate-pulse"></div></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          @for (item of loadingPlaceholder; track $index) {
            <tr>
              <td class="px-6 py-4"><div class="h-3 bg-muted rounded animate-pulse"></div></td>
              <td class="px-6 py-4"><div class="h-3 bg-muted rounded animate-pulse"></div></td>
              <td class="px-6 py-4"><div class="h-3 bg-muted rounded animate-pulse"></div></td>
              <td class="px-6 py-4"><div class="h-3 bg-muted rounded animate-pulse"></div></td>
              <td class="px-6 py-4"><div class="h-3 bg-muted rounded animate-pulse"></div></td>
              <td class="px-6 py-4"><div class="h-3 bg-muted rounded animate-pulse"></div></td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
}

<!-- Empty State -->
@else if (activities().length === 0) {
  <div class="text-center py-12 border border-border rounded-lg">
    <lucide-icon [img]="icons.calendar" [size]="64" class="text-muted-foreground mx-auto mb-4"></lucide-icon>
    <h3 class="text-xl font-semibold text-foreground mb-2">
      No se encontraron actividades
    </h3>
    <p class="text-muted-foreground mb-6">
      Ajusta los filtros o crea una nueva actividad para comenzar
    </p>
    <app-button iconName="Plus" iconPosition="left" [iconSize]="16">
      <span>Crear Primera Actividad</span>
    </app-button>
  </div>
}

<!-- Activities Table -->
@else {
  <div class="border border-border rounded-lg">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-border">
        <thead class="bg-muted/50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              <button (click)="onSelectAll()" class="flex items-center">
                <lucide-icon [img]="allSelected() ? icons.checkSquare : icons.square" [size]="16" [class]="allSelected() ? 'text-primary' : ''"></lucide-icon>
              </button>
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Actividad
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Estado
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Capacidad
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
              Fecha
            </th>
            <th scope="col" class="relative px-6 py-3">
              <span class="sr-only">Acciones</span>
            </th>
          </tr>
        </thead>
        <tbody class="bg-card divide-y divide-border">
          @for (activity of activities(); track activity.id) {
            <tr 
              (click)="viewEnrolled.emit(activity)"
              class="hover:bg-muted/50 transition-colors cursor-pointer"
              [class.bg-primary]="isSelected(activity.id)">
              <td class="px-6 py-4 whitespace-nowrap">
                <button (click)="$event.stopPropagation(); onToggleSelect(activity.id)" class="flex items-center">
                  <lucide-icon [img]="isSelected(activity.id) ? icons.checkSquare : icons.square" [size]="16" [class]="isSelected(activity.id) ? 'text-primary' : ''"></lucide-icon>
                </button>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center bg-primary/10 rounded-lg">
                    <lucide-icon [img]="getCategoryIcon(activity.category)" class="text-primary" [size]="20"></lucide-icon>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-foreground">{{ activity.title }}</div>
                    <div class="text-sm text-muted-foreground">{{ activity.instructor || 'Sin instructor' }}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span [class]="'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ' + getStatusColor(activity.statusActivity)">
                  {{ getStatusLabel(activity.statusActivity) }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="text-sm text-foreground">{{ activity.enrolled || 0 }}/{{ activity.capacity || 'âˆž' }}</div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                {{ formatDates(activity.date) }}
              </td>
              <td (click)="$event.stopPropagation()" class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <app-action-menu>
                  <!-- Conditional Actions based on status -->
                  @if (activity.statusActivity.toLowerCase() === 'pendiente') {
                    <button (click)="changeStatus.emit({ activity: activity, newStatus: 'i' })" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-sm font-body text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] hover:bg-[var(--color-muted)] transition-colors duration-200 cursor-pointer">
                      <lucide-icon [img]="icons.play" [size]="16" class="mr-2"></lucide-icon> Iniciar
                    </button>
                    <button (click)="changeStatus.emit({ activity: activity, newStatus: 'c' })" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-sm font-body text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] hover:bg-[var(--color-muted)] transition-colors duration-200 cursor-pointer">
                      <lucide-icon [img]="icons.stopCircle" [size]="16" class="mr-2"></lucide-icon> Cancelar
                    </button>
                  }
                  @if (activity.statusActivity.toLowerCase() === 'en curso') {
                    <button (click)="changeStatus.emit({ activity: activity, newStatus: 'f' })" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-sm font-body text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] hover:bg-[var(--color-muted)] transition-colors duration-200 cursor-pointer">
                      <lucide-icon [img]="icons.checkSquare" [size]="16" class="mr-2"></lucide-icon> Finalizar
                    </button>
                  }
                  @if (activity.statusActivity === 'c') {
                    <button (click)="changeStatus.emit({ activity: activity, newStatus: 'p' })" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-sm font-body text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] hover:bg-[var(--color-muted)] transition-colors duration-200 cursor-pointer">
                      <lucide-icon [img]="icons.undo2" [size]="16" class="mr-2"></lucide-icon> Reabrir
                    </button>
                  }
    
                  <!-- Common Actions -->
                  <button (click)="generateQr.emit(activity)" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-sm font-body text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] hover:bg-[var(--color-muted)] transition-colors duration-200 cursor-pointer">
                    <lucide-icon [img]="icons.qrCode" [size]="16" class="mr-2"></lucide-icon> Generar QR
                  </button>
                  <div class="my-1 h-px bg-border"></div> <!-- Separator -->
                  <button (click)="editActivity.emit(activity)" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-sm font-body text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] hover:bg-[var(--color-muted)] transition-colors duration-200 cursor-pointer">
                    <lucide-icon [img]="icons.edit" [size]="16" class="mr-2"></lucide-icon> Editar
                  </button>
                  <button (click)="deleteActivity.emit(activity.id)" class="w-full flex items-center space-x-3 px-4 py-2 text-left text-sm font-body text-red-600 hover:bg-red-500/10 transition-colors duration-200 cursor-pointer">
                    <lucide-icon [img]="icons.trash2" [size]="16" class="mr-2"></lucide-icon> Eliminar
                  </button>
                </app-action-menu>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
}