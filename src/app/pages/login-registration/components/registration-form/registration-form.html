@if (currentStep === 'verification') {
  <app-email-verification
    [email]="registrationEmail"
    [pass]="registrationPass"
    (onVerificationSuccess)="handleVerificationSuccess()"
    (onResendCode)="handleResendCode()"
    (onBackToRegistration)="handleBackToRegistration()"
  />
} @else {
  <form [formGroup]="registrationForm" (ngSubmit)="handleSubmit()" class="space-y-4">
    <!-- @if (generalError) {
      <div class="p-4 bg-[var(--color-error)]/10 border border-[var(--color-error)]/20 rounded-lg">
        <div class="flex items-start space-x-2">
          <lucide-icon [img]="icons.alertCircle" [size]="16" class="text-[var(--color-error)] mt-0.5"></lucide-icon>
          <p class="font-body font-medium text-sm text-[var(--color-error)]">
            {{ generalError }}
          </p>
        </div>
      </div>
    } -->

    @if (generalError && generalError.length > 0) {
    <div class="p-4 bg-[var(--color-error)]/10 border border-[var(--color-error)]/20 rounded-lg">
        <div class="flex items-start space-x-2">
            <lucide-icon [img]="icons.alertCircle" [size]="16" class="text-[var(--color-error)] mt-0.5"></lucide-icon>
            
            <div>
                @for (error of generalError; track $index) {
                    <p class="font-body font-medium text-sm text-[var(--color-error)] mb-1 last:mb-0">
                        {{ error }}
                    </p>
                }
            </div>
            
        </div>
    </div>
}

    <app-user-type-selector
      [selectedType]="userType"
      (onTypeChange)="handleUserTypeChange($event)"
    />

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <app-input
        label="Primer Nombre"
        type="text"
        name="pNombre"
        placeholder="Primer nombre"
        [value]="registrationForm.get('pNombre')?.value"
        (valueChange)="handleInputChange('pNombre', $event)"
        [error]="getControlError('pNombre')"
        [required]="true"
      />

      <app-input
        label="Segundo Nombre"
        type="text"
        name="sNombre"
        placeholder="Segundo nombre"
        [value]="registrationForm.get('sNombre')?.value"
        (valueChange)="handleInputChange('sNombre', $event)"
        [error]="getControlError('sNombre')"
        [required]="false"
      />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <app-input
        label="PrimerApellido"
        type="text"
        name="pApellido"
        placeholder="Primer apellido"
        [value]="registrationForm.get('pApellido')?.value"
        (valueChange)="handleInputChange('pApellido', $event)"
        [error]="getControlError('pApellido')"
        [required]="true"
      />

      <app-input
        label="Segundo Apellido"
        type="text"
        name="sApellido"
        placeholder="Segundo apellido"
        [value]="registrationForm.get('sApellido')?.value"
        (valueChange)="handleInputChange('sApellido', $event)"
        [error]="getControlError('sApellido')"
        [required]="false"
      />
    </div>

    <div class="gap-4">
      <app-input
        label="Correo Electrónico"
        type="email"
        name="email"
        [placeholder]="userType === 'internal' ? 'nombre@miumg.edu.gt' : 'tu@correo.com'"
        [description]="userType === 'internal' ? 'Debe ser un correo institucional' : 'Usaremos este correo para enviarte información del congreso'"
        [value]="registrationForm.get('email')?.value"
        (valueChange)="handleInputChange('email', $event)"
        [error]="getControlError('email')"
        [required]="true"
      />
    </div>
    

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="relative">
        <app-input
          label="Contraseña"
          [type]="showPassword ? 'text' : 'password'"
          name="password"
          placeholder="Mínimo 8 caracteres"
          [value]="registrationForm.get('password')?.value"
          (valueChange)="handleInputChange('password', $event)"
          [error]="getControlError('password')"
          [required]="true"
        />
        <button
          type="button"
          (click)="togglePasswordVisibility()"
          class="absolute right-3 top-9 text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] transition-colors duration-200"
        >
          <lucide-icon [img]="showPassword ? icons.eyeOff : icons.eye" [size]="18"></lucide-icon>
        </button>
      </div>

      <div class="relative">
        <app-input
          label="Confirmar Contraseña"
          [type]="showConfirmPassword ? 'text' : 'password'"
          name="confirmPassword"
          placeholder="Repite tu contraseña"
          [value]="registrationForm.get('confirmPassword')?.value"
          (valueChange)="handleInputChange('confirmPassword', $event)"
          [error]="getControlError('confirmPassword')"
          [required]="true"
        />
        <button
          type="button"
          (click)="toggleConfirmPasswordVisibility()"
          class="absolute right-3 top-9 text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] transition-colors duration-200"
        >
          <lucide-icon [img]="showConfirmPassword ? icons.eyeOff : icons.eye" [size]="18"></lucide-icon>
        </button>
      </div>
    </div>

    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <app-input
        label="Teléfono"
        type="tel"
        name="telefono"
        placeholder="5555 1234"
        [value]="registrationForm.get('telefono')?.value"
        (valueChange)="handleInputChange('telefono', $event)"
        [error]="getControlError('telefono')"
        [required]="true"
      />

      <app-input
        label="Fecha de Nacimiento"
        type="date"
        name="fechaNacimiento"
        [value]="registrationForm.get('fechaNacimiento')?.value"
        (valueChange)="handleInputChange('fechaNacimiento', $event)"
        [error]="getControlError('fechaNacimiento')"
        [required]="true"
      />
    </div>
    @if(validaEdad() || userType === 'internal'){
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <app-select
          label="Tipo Ident."
          placeholder="Selecciona"
          [options]="tipoIdentificacionOp"
          formControlName="tipoIdentificacionId"
          [error]="getControlError('tipoIdentificacionId')"
          [required]="true"
        />
        
        @if (isCarneSelected()) {
          <div class="md:col-span-2">
            <label class="font-body font-medium text-sm text-[var(--color-foreground)] block mb-1.5">Carné</label>
            <div formGroupName="carneGroup" class="grid grid-cols-3 gap-2">
              <app-input
                type="text"
                formControlName="carnePart1"
                maxlength="7"
                [error]="getControlError('carneGroup.carnePart1')"
              />
              <app-input
                type="text"
                formControlName="carnePart2"
                maxlength="7"
                [error]="getControlError('carneGroup.carnePart2')"
              />
              <app-input
                type="text"
                formControlName="carnePart3"
                maxlength="7"
                [error]="getControlError('carneGroup.carnePart3')"
              />
            </div>
          </div>
        } @else {
          <app-input
            label="Identificacion"
            type="text"
            formControlName="numeroIdentificacion"
            [error]="getControlError('numeroIdentificacion')"
            [required]="true"
            class="md:col-span-2"
          />
        }
      </div>
    }
    @if (userType === 'external') {
      <app-autocomplete-input
        [label]="'Escuela'"
        inputId="schoolId"
        [options]="schoolOp"
        [control]="schoolControl"
        [required]="userType === 'external'"
        [error]="getControlError('schoolId')"
        (optionSelectedObject)="onSchoolChange($event)"
      ></app-autocomplete-input>
    <br />
    <app-select
      label="Grado Académico"
      placeholder="Selecciona tu grado actual"
      [options]="gradeOp"
      formControlName="nivelAcademicoId"
      [error]="getControlError('nivelAcademicoId')"
      [required]="true"
    />
    <br>
    }
    @if (showSemestreField) {
      <app-input
        label="Semestre"
        type="number"
        placeholder="Ingresa el semestre"
        formControlName="semestre"
        [error]="getControlError('semestre')"
        [required]="true"
        min="1"
        max="10"
      />
    }
    <div class="space-y-3 pt-4 border-t border-[var(--color-border)]">
      <app-check-point
        label="Acepto los términos y condiciones del TechCongress"
        name="acceptTerms"
        [checked]="registrationForm.get('acceptTerms')?.value"
        (checkedChange)="handleInputChange('acceptTerms', $event)"
        [error]="getControlError('acceptTerms')"
        [required]="true"
      />

      <app-check-point
        label="Deseo recibir información sobre futuros eventos y oportunidades académicas"
        name="acceptMarketing"
        [checked]="registrationForm.get('acceptMarketing')?.value"
        (checkedChange)="handleInputChange('acceptMarketing', $event)"
      />
    </div>

    <app-button
      type="submit"
      variant="default"
      [loading]="isLoading"
      iconName="UserPlus"
      iconPosition="left"
      [fullWidth]="true"
    >
      <span>{{ isLoading ? 'Creando cuenta...' : 'Crear Cuenta' }}</span>
    </app-button>

    <div class="text-center pt-4">
      <p class="font-caption text-xs text-[var(--color-muted-foreground)]">
        Al registrarte, aceptas nuestros
        <button class="text-[var(--color-primary)] hover:text-[var(--color-primary)]/80 transition-colors duration-200">
          Términos de Servicio
        </button>
        y
        <button class="text-[var(--color-primary)] hover:text-[var(--color-primary)]/80 transition-colors duration-200">
          Política de Privacidad
        </button>
      </p>
    </div>
  </form>
}